<!DOCTYPE html>
<html>
<head>
<script type="application/javascript">
/*
    SVG Line Drawing Example
    Copyright (C) 2015 David Batley

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
var g_coords = [];
window.addEventListener("load", function(event) {
	document.getElementById("svgarea").addEventListener("click", function(event) {
		var bbox = event.currentTarget.getBoundingClientRect();
		g_coords.push({ x : event.clientX - bbox.left, y : event.clientY - bbox.top });
		draw();
	});
});
function draw(){
	draw_lines(document.getElementById("path1"));
	draw_curves(document.getElementById("path2"));
}

function draw_lines(elem) {
	var path_str = [];
	if (g_coords.length < 2) {
		return;
	}
	for (var i = 0; i < g_coords.length; ++i) {
		if (i == 0) {
			path_str.push("M " + g_coords[i].x + " " + g_coords[i].y);
		} else {
			path_str.push("L " + g_coords[i].x + " " + g_coords[i].y);
		}
	}
	elem.setAttribute("d", path_str.join(" "));
}

function draw_curves(elem) {
	var path_str = [];
	var rad = 50;
	if (g_coords.length < 2) {
		return;
	}
	for (var i = 0; i < g_coords.length; ++i) {
		if (i == 0) {
			path_str.push("M " + g_coords[i].x + " " + g_coords[i].y);
		} else if (i == g_coords.length-1) {
			path_str.push("L " + g_coords[i].x + " " + g_coords[i].y);
		} else {
			/*
			path_str.push("C");
			path_str.push((g_coords[i].x - rad) + " " + (g_coords[i].y - rad));
			path_str.push((g_coords[i].x + rad) + " " + (g_coords[i].y + rad));
			path_str.push(g_coords[i].x + " " + g_coords[i].y);
			*/
			var theta_n = angle_normal(g_coords[i-1], g_coords[i], g_coords[i+1]);
			var dx = rad *  Math.sin(theta_n);
			var dy = rad *  Math.cos(theta_n);
			path_str.push("L " + g_coords[i].x + " " + g_coords[i].y);
			path_str.push("L " + (g_coords[i].x+dx) + " " + (g_coords[i].y+dy));
			path_str.push("L " + g_coords[i].x + " " + g_coords[i].y);
		}
	}
	elem.setAttribute("d", path_str.join(" "));
}

function mod(blah, base) {
	var rtn = blah % base;
	if (rtn < 0) {
		return rtn + base;
	} else {
		return rtn;
	}
}

function angle_normal(a, b, c) {
	var theta_a = mod(angle_btn(a, b), 2*Math.PI);
	var theta_c = mod(angle_btn(c, b), 2*Math.PI);
	if (theta_c + theta_a < 2*Math.PI) {
		return (theta_a + theta_c) / 2.0;
	} else {
		return Math.PI + (theta_a + theta_c) / 2.0;
	}
}

function angle_btn(a, b) {
	/*
	Angle between BA and vertical, at B.
	*/
	var dx = a.x - b.x;
	var dy = a.y - b.y;
	var r = Math.sqrt(dx*dx + dy*dy); /* positive root */
	if (dy > 0) {
		return Math.asin(dx / r);
	} else {
		return Math.PI - Math.asin(dx / r);
	}
}

/*
function assert(x, v){
	document.write("<div>" + x + "<br>" + eval(x) + " (" + v + ")</div>");
}
assert("(angle_btn({x: 100, y: 200}, {x: 100, y: 100}) / Math.PI * 180 + 3600) % 360", 0)
assert("(angle_btn({x: 200, y: 200}, {x: 100, y: 100}) / Math.PI * 180 + 3600) % 360", 45)
assert("(angle_btn({x: 200, y: 100}, {x: 100, y: 100}) / Math.PI * 180 + 3600) % 360", 90)
assert("(angle_btn({x: 200, y: 0}, {x: 100, y: 100}) / Math.PI * 180 + 3600) % 360", 135)
assert("(angle_btn({x: 100, y: 0}, {x: 100, y: 100}) / Math.PI * 180 + 3600) % 360", 180)
assert("(angle_btn({x: 0, y: 0}, {x: 100, y: 100}) / Math.PI * 180 + 3600) % 360", 225)
assert("(angle_btn({x: 0, y: 100}, {x: 100, y: 100}) / Math.PI * 180 + 3600) % 360", 270)
assert("(angle_btn({x: 0, y: 200}, {x: 100, y: 100}) / Math.PI * 180 + 3600) % 360", 315)
*/
</script>
</head>
<body>
	<svg id="svgarea" width="750px" height="500px" version="1.1" xmlns="http://www.w3.org/2000/svg" style="background: #003366">
		<path id="path1" stroke="#cc7700" fill="transparent"/>
		<path id="path2" stroke="#ffffff" fill="transparent"/>
	</svg>
</body>
</html>

